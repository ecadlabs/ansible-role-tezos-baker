---

# tasks file for roles/tezos_baker

- name: change tezos_network variable
  set_fact:
    network_name: "{{ tezos_network | regex_search('([^/]*)$') }}"
  when: tezos_network is regex("((http|https)\:\/\/)?[a-zA-Z0-9\.\/\?\:@\-_=#]+\.([a-zA-Z]){2,6}([a-zA-Z0-9\.\&\/\?\:@\-_=#])*")

- name: change node and client directory names
  set_fact:
    node_data_dir: "/srv/tezos/{{ network_name }}_node"
    client_data_dir: "/srv/tezos/{{ network_name }}_client"
    node_rpc_url: "{% if node_rpc_url is defined %}{{ node_rpc_url }}{% else %}http://{{ network_name }}_node:{{ RPC_PORT_INTERNAL }}{% endif %}"
  when: network_name is defined

- name: Tezos baker container
  ignore_errors: yes
  docker_container:
    name: "{% if network_name is defined %}{{ network_name }}{% else %}{{ tezos_network }}{% endif %}_baker_{{ item }}"
    image: "{{ tezos_docker_image }}"
    state: started
    recreate: yes
    restart: yes
    restart_policy: always
    pull: yes
    networks:
      - name: "{% if network_name is defined %}{{ network_name }}{% else %}{{ tezos_network }}{% endif %}"
    entrypoint: >
      tezos-baker-{{ item }} --chain main --base-dir "/home/tezos/.tezos-client"
      --endpoint "{{ node_rpc_url }}"
      run with local node /data/node
    volumes:
      - "{{ node_data_dir }}:/data/node"
      - "{{ client_data_dir }}:/home/tezos/.tezos-client"
  with_items: "{{ tezos_economic_protocols }}"

- name: Tezos endorser container
  ignore_errors: yes
  docker_container:
    name: "{% if network_name is defined %}{{ network_name }}{% else %}{{ tezos_network }}{% endif %}_endorser_{{ item }}"
    image: "{{ tezos_docker_image }}"
    state: started
    recreate: yes
    restart: yes
    restart_policy: always
    pull: yes
    networks:
      - name: "{% if network_name is defined %}{{ network_name }}{% else %}{{ tezos_network }}{% endif %}"
    entrypoint: >
      tezos-endorser-{{ item }}  --chain main --base-dir "/home/tezos/.tezos-client"
      --endpoint "{{ node_rpc_url }}"
      run
    volumes:
      - "{{ client_data_dir }}:/home/tezos/.tezos-client"
  with_items: "{{ tezos_economic_protocols }}"

- name: Tezos accuser container
  ignore_errors: yes
  docker_container:
    name: "{% if network_name is defined %}{{ network_name }}{% else %}{{ tezos_network }}{% endif %}_accuser_{{ item }}"
    image: "{{ tezos_docker_image }}"
    state: started
    recreate: yes
    restart: yes
    restart_policy: always
    pull: yes
    networks:
      - name: "{% if network_name is defined %}{{ network_name }}{% else %}{{ tezos_network }}{% endif %}"
    entrypoint: >
      tezos-accuser-{{ item }} --chain main --base-dir "/home/tezos/.tezos-client"
      --endpoint "{{ node_rpc_url }}"
      run
    volumes:
      - "{{ client_data_dir }}:/home/tezos/.tezos-client"
  with_items: "{{ tezos_economic_protocols }}"
